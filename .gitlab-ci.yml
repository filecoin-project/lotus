default:
  image: registry.sxxfuture.net/lib/docker/lotus-builder/debian:230224-002040

stages:
  - build

v18:build lotus:
  tags: [docker, x86, merak]
  stage: build
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
    HTTP_PROXY: $DEFAULT_PROXY
    HTTPS_PROXY: $DEFAULT_PROXY
    http_proxy: $DEFAULT_PROXY
    https_proxy: $DEFAULT_PROXY
    RUSTFLAGS: ""
    GOFLAGS: ""
  cache:
    - key:
        files:
          - go.mod
          - go.sum
      paths:
        - .go/
    - key: build-deps-$CI_COMMIT_REF_SLUG
      paths:
        - build/.update-modules
        - build/.filecoin-install
        - extern/serialization-vectors/
        - extern/test-vectors/
        - extern/filecoin-ffi/
  artifacts:
    paths: [lotus, lotus-miner, lotus-worker, lotus-shed, lotus-wallet, lotus-gateway, lotus-stats]
  before_script:
    # ci cache will create empty dir, which should not exist
    - ls -alh extern
    - echo "ls -A"
    - ls -A extern/serialization-vectors
    - echo "determine empty:"
    - '[ -z "$(ls -A extern/serialization-vectors)" ] && echo empty'
    - '[ -z "$(ls -A extern/serialization-vectors)" ] && rm -r extern/serialization-vectors'
    - '[ -z "$(ls -A extern/test-vectors)" ] && rm -r extern/test-vectors'
    - '[ -z "$(ls -A extern/filecoin-ffi)" ] && rm -r extern/filecoin-ffi'
    - ls -alh extern
    - mkdir -p .go
  script:
    - ls -alh && echo "\n" && ls -alh build && echo "\n" && ls -alh extern
    - make lotus lotus-miner lotus-worker lotus-shed lotus-wallet lotus-gateway lotus-stats
  only:
    refs:
      - v18_of_car_filbase
